import numpy as np
from delay_calc import calc_access_delay_s, calc_access_delay_u
import matplotlib.pyplot as plt
from p_calc import calc_ss_p_fsolve, calc_ss_p_formula, calc_ps_p_formula, calc_ps_p_fsolve

tt = 35.8667
tf = 27.2444

lambda_mld_range = np.arange(0.0002, 0.0041, 0.0002) * tt * 0.5
lambda_sld = [0.001 * tt, 0.002 * tt]


sim_p_mld_link1_w8 = [0.96558, 0.953658, 0.947277, 0.931176, 0.917194, 0.90467, 0.883681, 0.852458, 0.823202, 0.778493, 0.726813, 0.647472, 0.515109, 0.509462, 0.505794, 0.511253, 0.509646, 0.511563, 0.512037, 0.510103]
sim_p_mld_link2_w8 =[0.801849, 0.706374, 0.621516, 0.503547, 0.500064, 0.499894, 0.504574, 0.506943, 0.502602, 0.501528, 0.508009, 0.504797, 0.499556, 0.503466, 0.502145, 0.499829, 0.503599, 0.504139, 0.501768, 0.502991]



sim_p_mld_link1_w32 = [0.972628, 0.964338, 0.964538, 0.958064, 0.948766, 0.939547, 0.930587, 0.910836, 0.896491, 0.874064, 0.853243, 0.820159, 0.777428, 0.675112, 0.670674, 0.67111, 0.669291, 0.669431, 0.670053, 0.671905]
sim_p_mld_link2_w32 = [0.873192, 0.820283, 0.762943, 0.659758, 0.653475, 0.651119, 0.655477, 0.657845, 0.653707, 0.658835, 0.658843, 0.65555, 0.649835, 0.652101, 0.652349, 0.660645, 0.653909, 0.648475, 0.652336, 0.651464]

sim_p_mld_link1_w128 = [0.979179, 0.976425, 0.973213, 0.967541, 0.962853, 0.956524, 0.950692, 0.944715, 0.935099, 0.922238, 0.907839, 0.889738, 0.861852, 0.840035, 0.837474, 0.83832, 0.841033, 0.840806, 0.839331, 0.839812]
sim_p_mld_link2_w128 = [0.909898, 0.886925, 0.837366, 0.804967, 0.805364, 0.802947, 0.797512, 0.806788, 0.805033, 0.800138, 0.799654, 0.799283, 0.801325, 0.798799, 0.80439, 0.799669, 0.799643, 0.805656, 0.800385, 0.799119]


sim_acc_mld_link1_w8 = [0.42651, 0.460221, 0.477066, 0.522287, 0.573575, 0.628538, 0.70945, 0.840136, 0.997201, 1.28282, 1.69676, 2.64821, 6.95196, 7.37051, 7.4762, 7.5044, 7.5761, 7.58393, 7.60752, 7.66579]
sim_acc_mld_link2_w8 = [3.53826, 5.91955, 9.58526, 25.0742, 26.5672, 26.9231, 27.0474, 27.2371, 27.4688, 27.5908, 27.3951, 27.7294, 27.8536, 27.8689, 28.2254, 28.289, 28.0466, 28.2291, 28.1785, 28.2691]

sim_acc_mld_link1_w32 = [0.542596, 0.609892, 0.640002, 0.705908, 0.771226, 0.858147, 0.952116, 1.1078, 1.27649, 1.52051, 1.84932, 2.31555, 3.19839, 6.41562, 6.73772, 6.81768, 6.86171, 6.89416, 6.9341, 6.97942]
sim_acc_mld_link2_w32 = [5.1201, 7.49341, 10.6609, 23.2543, 24.8039, 25.1636, 25.4215, 25.6517, 25.9027, 25.8059, 26.0535, 26.1414, 26.5247, 26.4855, 26.4307, 26.4059, 26.6714, 26.7944, 26.7095, 26.7785]

sim_acc_mld_link1_w128 = [0.898787, 1.00076, 1.09813, 1.23757, 1.40262, 1.56579, 1.76587, 2.02426, 2.34593, 2.75209, 3.32654, 4.09838, 5.55374, 6.77057, 6.85839, 6.9214, 6.94195, 6.98824, 7.02508, 7.05236]
sim_acc_mld_link2_w128 = [9.01409, 12.1114, 18.2631, 25.9855, 26.8262, 27.2464, 27.617, 27.6689, 27.8984, 28.1709, 28.3814, 28.4057, 28.4249, 28.5964, 28.5245, 28.5986, 28.5457, 28.645, 28.6441, 28.7964]

ana_p_mld_link1_w8 = [0.9815769076912796,0.9785684894768211,0.9751242084911603,0.9711371721528637,0.9664604045633463,0.9608848933922396,0.9541003907898884,0.9456195051994711,0.9346133527582388,0.9194917472385723,0.8964856716052141,0.850384057984429,0.48687999999948695,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879]
ana_p_mld_link2_w8 = [0.8964856716052141,0.8503840579844288,0.5864399999995865,0.5796199999995797,0.5723799999995725,0.5646999999995648,0.5564599999995565,0.5476199999995477,0.5379999999995381,0.5274399999995275,0.5156999999995158,0.5023999999995025,0.48687999999948695,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879,0.471568170246879]

ana_p_mld_link1_w32 = [0.9815769076912796,0.9785684894768211,0.9751242084911603,0.9711371721528637,0.9664604045633463,0.9608848933922396,0.9541003907898884,0.9456195051994711,0.9346133527582388,0.9194917472385723,0.8964856716052141,0.850384057984429,0.6260199999996261,0.6260199999996261,0.6260199999996261,0.6260199999996261,0.6260199999996261,0.6260199999996261,0.6260199999996261,0.6260199999996261]
ana_p_mld_link2_w32 = [0.8964856716052141,0.8503840579844288,0.5864399999995865,0.5796199999995797,0.5723799999995725,0.5646999999995648,0.5564599999995565,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937,0.5531724348910937]

ana_p_mld_link1_w128 = [0.9815769076912796,0.9785684894768211,0.9751242084911603,0.9711371721528637,0.9664604045633463,0.9608848933922396,0.9541003907898884,0.9456195051994711,0.9346133527582388,0.9194917472385723,0.8964856716052141,0.850384057984429,0.8203399999998204,0.8203399999998204,0.8203399999998204,0.8203399999998204,0.8203399999998204,0.8203399999998204,0.8203399999998204,0.8203399999998204]
ana_p_mld_link2_w128 = [0.8964856716052141,0.8503840579844288,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962,0.587446594797962]


ana_acc_mld_link1_w8 = [44.08625106045718,44.68883617531583,45.38651297481711,46.204726729167106,47.179324335680846,48.36274389209247,49.8354601572145,51.72905928945345,54.278605368559695,57.964152883065765,64.02354545220204,78.17268347841322,662.4104632687414,748.505529004268,748.505529004268,748.505529004268,748.505529004268,748.505529004268,748.505529004268,748.505529004268]
ana_acc_mld_link2_w8 = [65.04303884367052,79.77618727291062,331.2799867776488,345.72277905244925,362.035367788891,380.51394325270286,401.80320381740745,426.45406398273366,455.62165802022605,490.7253111497709,533.9604274149566,588.9636938879653,662.4104632687414,748.505529004268,748.505529004268,748.505529004268,748.505529004268,748.505529004268,748.505529004268,748.505529004268]

ana_acc_mld_link1_w32 = [64.684418776663,66.67690223149057,68.98620040847425,71.69772666837156,74.93206349940857,78.86603351605433,83.77177669782876,90.09579658814403,98.63905185856663,111.045903855966,131.58635013056875,180.1996730650599,790.6552858299435,790.6552858299435,790.6552858299435,790.6552858299435,790.6552858299435,790.6552858299435,790.6552858299435,790.6552858299435]
ana_acc_mld_link2_w32 = [135.35982267738078,186.16439310997157,1122.2342747802109,1177.6057069985377,1240.2460277195196,1311.319862039378,1393.3420789971638,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286,1431.079874313286]

ana_acc_mld_link1_w128 = [147.07708964148628,154.62916645618952,163.38495014310286,173.6697264251893,185.9430201543194,200.8791920119018,219.51704286028573,243.5627457829063,276.0808378185944,323.3729077475669,401.8375688440356,588.3076314116465,732.8771282072447,732.8771282072447,732.8771282072447,732.8771282072447,732.8771282072447,732.8771282072447,732.8771282072447,732.8771282072447]
ana_acc_mld_link2_w128 = [416.62695801222185,611.7172164582154,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075,4266.668285518075]


ana_que_mld_link1_w8 = [0.09810988573855453,0.20355655703407258,0.31832244075140836,0.44523090031178425,0.5884522114289771,0.7544306083723641,0.9537145579199611,1.204940691410254,1.544748271589138,2.0578586619322774,3.0046486313528344,6.035241825951911,666666,666666,666666,666666,666666,666666,666666,666666]
ana_que_mld_link2_w8 = [0.2654497661727482,0.974299181738483,163.0780435944355,254.16648497021848,376.3243443313594,543.179949976999,777.8434634893223,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666]
sim_que_mld_link1_w8 = [0.000834862, 0.00516988, 0.00626528, 0.0121441, 0.0192371, 0.0333355, 0.0552781, 0.115499, 0.237135, 0.546885, 1.2772, 5.19825, 661.58, 1958.94, 3191.94, 4165.49, 5115.19, 5755.74, 6541.04, 7204.15]
sim_que_mld_link2_w8 = [0.312574, 2.16431, 13.6596, 2503.23, 5921.48, 8224.02, 9733.56, 11014.2, 11851.8, 12590.7, 13231.9, 13769.5, 14195.6, 14512.5, 14932.4, 15180.4, 15389.9, 15636.8, 15908.5, 16064.7]

ana_que_mld_link1_w32 = [0.22759219925294913,0.49248030603120607,0.8070887057834124,1.1898585011663678,1.6692837491472752,2.291637605842721,3.136983619792625,4.355979030930547,6.267384536484977,9.676813766451783,17.363592374581636,50.54928672057649,666666,666666,666666,666666,666666,666666,666666,666666]
ana_que_mld_link2_w32 = [1.4578171506113748,7.375279387546709,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666]
sim_que_mld_link1_w32 = [0.00166605, 0.00640524, 0.0155231, 0.0254503, 0.0412859, 0.0637206, 0.100996, 0.17758, 0.307777, 0.551974, 1.01366, 2.17714, 7.61854, 497.084, 1759.58, 2845.46, 3827.19, 4642.61, 5384.9, 6120.0]
sim_que_mld_link2_w32 = [0.537251, 2.79621, 11.6307, 1479.29, 5242.97, 7368.97, 9089.57, 10436.1, 11544.0, 12164.5, 12864.3, 13384.6, 13947.7, 14251.0, 14666.6, 14930.5, 15224.1, 15479.2, 15610.9, 15829.6]

ana_que_mld_link1_w128 = [1.358929522347993,3.09703035564489,5.368454237798464,8.4140306705275,12.627552790639676,18.69063163885968,27.872673692049993,42.781512327220625,69.57563996749687,126.31372736690639,291.75402356222446,666666,666666,666666,666666,666666,666666,666666,666666,666666]
ana_que_mld_link2_w128 = [16.648024872118867,102.79279684247825,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666,666666]
sim_que_mld_link1_w128 = [0.00604631, 0.0301365, 0.0513288, 0.0858698, 0.149017, 0.240898, 0.335195, 0.584438, 0.985093, 1.59375, 3.22153, 6.91669, 40.0267, 790.828, 1976.12, 3052.01, 3985.1, 4830.47, 5533.05, 6231.96]
sim_que_mld_link2_w128 = [1.5301, 6.97402, 68.0945, 2837.47, 6196.37, 8334.12, 9978.6, 11232.2, 12147.2, 12816.0, 13403.7, 13948.6, 14438.4, 14746.5, 15035.5, 15344.6, 15592.7, 15789.8, 15958.5, 16225.9]
# access_delay_list8 = []
# queueing_delay8 = []
# for lambda1, p in zip(lambda_mld_range, sim_p_mld_link1_w8):
#     qd, ad = calc_access_delay_u(p, tt, tf, 8, 6, lambda1)
    
#     queueing_delay8.append(qd)
#     access_delay_list8.append(ad)


# access_delay_list32 = []
# queueing_delay32 = []
# for lambda1, p in zip(lambda_mld_range, sim_p_mld_link1_w32):
#     qd, ad = calc_access_delay_u(p, tt, tf, 32, 6, lambda1)
#     queueing_delay32.append(qd)
#     access_delay_list32.append(ad)

# access_delay_list128 = []
# queueing_delay128 = []
# for lambda1, p in zip(lambda_mld_range, sim_p_mld_link1_w128):
#     qd, ad = calc_access_delay_u(p, tt, tf, 128, 6, lambda1)
#     queueing_delay128.append(qd)
#     access_delay_list128.append(ad)
# plt.figure(1)
# plt.title("W=8 access delay contrast")
# plt.plot(lambda_mld_range, access_delay_list8, label="model(sim_p)")
# plt.plot(lambda_mld_range, np.array(sim_acc_mld_link1_w8)/0.009, label="sim")
# plt.plot(lambda_mld_range,ana_acc_mld_link1_w8,label="model(model_p)" )
# plt.legend()
# # plt.figure()
# plt.figure(2)
# plt.title("W=32 access delay contrast")
# plt.plot(lambda_mld_range, access_delay_list32, label="model(sim_p)")
# plt.plot(lambda_mld_range, np.array(sim_acc_mld_link1_w32)/0.009, label="sim")
# plt.plot(lambda_mld_range,ana_acc_mld_link1_w32,label="model(model_p)" )
# plt.legend()

# plt.figure(3)
# plt.title("W=128 access delay contrast")
# plt.plot(lambda_mld_range, access_delay_list128, label="model(sim_p)")
# plt.plot(lambda_mld_range, np.array(sim_acc_mld_link1_w128)/0.009, label="sim")
# plt.plot(lambda_mld_range,ana_acc_mld_link1_w128,label="model(model_p)" )
# plt.legend()

# plt.figure(4)
# plt.title("W=8 queueing delay contrast")
# plt.plot(lambda_mld_range[:-9], queueing_delay8[:-9], label="model(sim_p)")
# plt.scatter(lambda_mld_range[:-9], (np.array(sim_que_mld_link1_w8)/0.009)[:-9], label="sim")
# plt.plot(lambda_mld_range[:-9],ana_que_mld_link1_w8[:-9],label="model(model_p)" )
# plt.legend()
# # plt.figure()
# plt.figure(5)
# plt.title("W=32 queueing delay contrast")
# plt.plot(lambda_mld_range[:-9], queueing_delay32[:-9], label="model(sim_p)")
# plt.scatter(lambda_mld_range[:-9], (np.array(sim_que_mld_link1_w32)/0.009)[:-9], label="sim")
# plt.plot(lambda_mld_range[:-9],ana_que_mld_link1_w32[:-9],label="model(model_p)" )
# plt.legend()

# plt.figure(6)
# plt.title("W=128 queueing delay contrast")
# plt.plot(lambda_mld_range[:-9], queueing_delay128[:-9], label="model(sim_p)")
# plt.scatter(lambda_mld_range[:-9], (np.array(sim_que_mld_link1_w128)/0.009)[:-9], label="sim")
# plt.plot(lambda_mld_range[:-9],ana_que_mld_link1_w128[:-9],label="model(model_p)" )
# plt.legend()
# plt.show()

from state_ana import calc_pi_T_S
sim_throughput8 = 16.43 * 9 / 8 / 1500*35.8667
sim_throughput32 = 17.9576 * 9 / 8 / 1500*35.8667
print(sim_throughput32)
ana_throughput = 0.4791774891457814
for lambda1 in lambda_mld_range:
    if lambda1 > 0.0030 * 0.5 * tt:
        p_us1, p_us2, p_su1, p_su2 = calc_ps_p_formula(10, lambda1, 10, lambda_sld[0], 32, 6, 16, 6, tt, tf)
        p_us1_, p_us2_, p_su1_, p_su2_ = calc_ps_p_fsolve(10, lambda1, 10, lambda_sld[0], 32, 6, 16, 6, tt, tf)
        print("lambda1:", lambda1)
        print(p_us1, p_us2, p_su1, p_su2)
        print(p_us1_, p_us2_, p_su1_, p_su2_)
        throughput_ps = calc_pi_T_S(p_su1, tt, tf, 32, 6) * 10
        throughput_ps2 = calc_pi_T_S(p_su1_, tt, tf, 32, 6) * 10
        print(throughput_ps, throughput_ps2)
        print()
        